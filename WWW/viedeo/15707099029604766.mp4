package cn.carsh.job.task.processor;

import cn.carsh.job.pojo.UsNewsInfo;
import cn.carsh.job.task.UsNewsDataPipeline;
import org.jsoup.Jsoup;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import us.codecraft.webmagic.Page;
import us.codecraft.webmagic.Site;
import us.codecraft.webmagic.Spider;
import us.codecraft.webmagic.processor.PageProcessor;
import us.codecraft.webmagic.scheduler.BloomFilterDuplicateRemover;
import us.codecraft.webmagic.scheduler.QueueScheduler;
import us.codecraft.webmagic.selector.Html;
import us.codecraft.webmagic.selector.Selectable;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Component
public class QsSubjectProcessor implements PageProcessor {
    private String url = "https://www.topuniversities.com/subject-rankings/2019";
    private Site site = Site.me()
            .addHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
            .addHeader("Accept-Encoding","gzip, deflate, sdch")
            .addHeader("Accept-Language","zh-CN,zh;q=0.8")
            .addHeader("User-Agent", "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.71 Safari/537.36")
            .setCharset("utf8")
            .setTimeOut(50000)
            .setRetrySleepTime(5000)
            .setRetryTimes(3)
            ;
    private Set set = new HashSet();
    @Override
    public void process(Page page) {
        String html = page.getHtml().toString();
        List<Selectable> list = page.getHtml().css("div.sub-list a").nodes();
        if (list.size()==0){
            this.saveInfo(page);
        }else{
            for (Selectable selectable : list) {
                String JobInfoUrl = selectable.links().toString();

                page.addTargetRequest(JobInfoUrl);
            }
            //.get(2).links().toString();//*[@id="qs-rankings_paginate"]/span/a[2]
//            List<Selectable> bkUrl = page.getHtml().css("div#qs-rankings_paginate a").nodes();
//            System.out.println(bkUrl.size());
//          //  page.addTargetRequest(bkUrl);
        }
    }

    //解析页面获取的详情信息
    private void saveInfo(Page page) {
        Html html = page.getHtml();
        String subject = html.css("div.pane-content div.image-text","text").toString();
        System.out.println(subject);
//        String subjectName = subject.split("for").length==1?"Befault Rankings":subject.split("for ")[1];
//        List<UsNewsInfo> root = new ArrayList<>();
//        List<Selectable> list = page.getHtml().css("div#resultsMain div.sep").nodes();
//        for (int i=1;i<list.size();i++){
//            UsNewsInfo info = new UsNewsInfo();
//            Selectable htmlSel = list.get(i);
//            String rank = Jsoup.parse(htmlSel.css("span").nodes().get(0).toString()).text();
//            String school = htmlSel.css("h2.h-taut a","text").toString();
//            info.setSubject(subjectName);
//            info.setRanking(rank);
//            info.setSchool(school);
//            root.add(info);
//        }
//        page.putField("usnews",root);
    }

    @Override
    public Site getSite() {
        return site;
    }

    /**
     *
     */
    @Autowired
    private UsNewsDataPipeline springDataPipeline;

    @Scheduled(initialDelay = 1000,fixedDelay = 10000)
    public void process(){
        Spider.create(new QsSubjectProcessor())
                .addUrl(url)
                .setScheduler(new QueueScheduler().setDuplicateRemover(new BloomFilterDuplicateRemover(40000)))
                .thread(10)
                .addPipeline(this.springDataPipeline)
                .run();
    }
}
